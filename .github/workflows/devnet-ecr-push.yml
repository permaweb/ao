name: Build and Push ao/server images to ECR when raising a PR

on:
  pull_request:
    branches:
      - '*'

jobs:
  login:
    runs-on: ubuntu-latest
    outputs:
      ecr_login: ${{ steps.login-ecr.outputs.ecr_login }}
    steps:
      - name: Log in to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v1

  build-and-push-cu:
    needs: login
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v1

      - name: Extract shortened commit hash
        id: vars
        run: echo "COMMIT_HASH=$(echo $GITHUB_SHA | cut -c1-7)" >> $GITHUB_ENV

      - name: Build and push CU Docker image
        run: |
          docker build -t ${{ secrets.AWS_DEVNET_ACCOUNT_ID }}.dkr.ecr.${{ secrets.AWS_DEVNET_REGION }}.amazonaws.com/devnet-ecr:ao-cu-$COMMIT_HASH -f servers/cu/Dockerfile .
          docker push ${{ secrets.AWS_DEVNET_ACCOUNT_ID }}.dkr.ecr.${{ secrets.AWS_DEVNET_REGION }}.amazonaws.com/devnet-ecr:ao-cu-$COMMIT_HASH

  build-and-push-mu:
    needs: login
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v1

      - name: Extract shortened commit hash
        id: vars
        run: echo "COMMIT_HASH=$(echo $GITHUB_SHA | cut -c1-7)" >> $GITHUB_ENV

      - name: Build and push MU Docker image
        run: |
          docker build -t ${{ secrets.AWS_DEVNET_ACCOUNT_ID }}.dkr.ecr.${{ secrets.AWS_DEVNET_REGION }}.amazonaws.com/devnet-ecr:ao-mu-$COMMIT_HASH -f servers/mu/Dockerfile .
          docker push ${{ secrets.AWS_DEVNET_ACCOUNT_ID }}.dkr.ecr.${{ secrets.AWS_DEVNET_REGION }}.amazonaws.com/devnet-ecr:ao-mu-$COMMIT_HASH

  build-and-push-su:
    needs: login
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v1

      - name: Extract shortened commit hash
        id: vars
        run: echo "COMMIT_HASH=$(echo $GITHUB_SHA | cut -c1-7)" >> $GITHUB_ENV

      - name: Build and push SU Docker image
        run: |
          docker build -t ${{ secrets.AWS_DEVNET_ACCOUNT_ID }}.dkr.ecr.${{ secrets.AWS_DEVNET_REGION }}.amazonaws.com/devnet-ecr:ao-su-$COMMIT_HASH -f servers/su/Dockerfile.x86 .
          docker push ${{ secrets.AWS_DEVNET_ACCOUNT_ID }}.dkr.ecr.${{ secrets.AWS_DEVNET_REGION }}.amazonaws.com/devnet-ecr:ao-su-$COMMIT_HASH
